using System;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Collections.Generic;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace Maverick.Azure.ApplicationInsightsManager
{
    // Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
    // To generate Base64 string for Images below, you can use https://www.base64-image.de/
    [Export(typeof(IXrmToolBoxPlugin)),
        ExportMetadata("Name", "Application Insights Manager"),
        ExportMetadata("Description", "Create application insight web resource. Add or remove application insight web resource on Entity Form."),
        // Please specify the base64 content of a 32x32 pixels image
        ExportMetadata("SmallImageBase64", "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"),
        // Please specify the base64 content of a 80x80 pixels image
        ExportMetadata("BigImageBase64", "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"),
        ExportMetadata("BackgroundColor", "White"),
        ExportMetadata("PrimaryFontColor", "Black"),
        ExportMetadata("SecondaryFontColor", "Gray")]
    public class MainPlugin : PluginBase
    {
        public override IXrmToolBoxPluginControl GetControl()
        {
            return new MainPluginControl();
        }

        /// <summary>
        /// Constructor 
        /// </summary>
        public MainPlugin()
        {
            // If you have external assemblies that you need to load, uncomment the following to 
            // hook into the event that will fire when an Assembly fails to resolve
            // AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
        }

        /// <summary>
        /// Event fired by CLR when an assembly reference fails to load
        /// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
        /// For example, a folder named Sample.XrmToolBox.MyPlugin 
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
        {
            Assembly loadAssembly = null;
            Assembly currAssembly = Assembly.GetExecutingAssembly();

            // base name of the assembly that failed to resolve
            var argName = args.Name.Substring(0, args.Name.IndexOf(","));

            // check to see if the failing assembly is one that we reference.
            List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
            var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

            // if the current unresolved assembly is referenced by our plugin, attempt to load
            if (refAssembly != null)
            {
                // load from the path to this plugin assembly, not host executable
                string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
                string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
                dir = Path.Combine(dir, folder);

                var assmbPath = Path.Combine(dir, $"{argName}.dll");

                if (File.Exists(assmbPath))
                {
                    loadAssembly = Assembly.LoadFrom(assmbPath);
                }
                else
                {
                    throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
                }
            }

            return loadAssembly;
        }
    }
}